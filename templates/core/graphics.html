{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead  %}
<link rel="shortcut icon" type="image/png" href="{% static 'img/logos/Cat3.png' %}">

<!-- Stylesheets -->
<link rel="stylesheet" href="{% static 'css/fontawesome.min.css' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="{% static 'css/core.css' %}">
<script defer src="https://use.fontawesome.com/releases/v5.8.1/js/all.js"
    integrity="sha384-g5uSoOSBd7KkhAMlnQILrecXvzst9TdC09/VM+pjDTCM+1il8RHz5fKANTFFb+gQ"
    crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'admin/css/base.css' %}">
            <link rel="stylesheet" href="{% static 'css/core.css' %}">
            <script src="https://code.highcharts.com/stock/highstock.js"></script>
            <script src="https://code.highcharts.com/stock/modules/data.js"></script>
            <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
            <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
{% endblock %}

{% block title %}Petcare{% endblock %}


{% block branding %}
<div class="row col-12 pb-0 p-2 pl-3">
    <div class="col-4 d-xs-none d-md-block d-flex align-items-center pt-4px">
        PetCare - CRM
    </div>
    <div class="col-4 col-xs-12 d-flex justify-content-center">
        <img class="mini-logo" src="{% static 'img/logos/Cat.png' %}" alt="">
    </div>
    <div class="col-4 d-flex justify-content-end d-flex align-items-center">
        <img class="profile-picture" src="https://i.imgur.com/Qv8PA8G.png" alt="Profile">

        {{ request.user }}
    </div>
</div>
{% endblock %}


{% block nav-global %}
<header>
    {% include 'base/base_menu.html' %}
</header>

{% endblock %}
{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="/admin/">Inicio</a>
    › Estadísticas
</div>
{% endblock %}
{% block content %}
<div class="container-fluid d-flex flex-column">

    <div class="w-100"></div>
    <div id="sales-chart" style="height: 400px; min-width: 750px; width: 100%;"></div>
    <div class="row">
        <table class="table">
            <tr>
                <th>Producto</th>
                <th>Descripción</th>
                <th>Categoría</th>
                <th>Precio</th>
                <th>Total ventas</th>
            </tr>
            {% for product in best_selling %}
            <tr>
                <td>{{ product.name }}</td>
                <td>{{ product.description }}</td>
                <td>{{ product.category }}</td>
                <td>{{ product.price }}</td>
                <td>{{ product.total_orders }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>
<script defer>
    // Obtener el csrf_token
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // Petición ajax
    var data = []
    var csrftoken = getCookie('csrftoken');
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {

            data = JSON.parse(this.responseText)
            data.forEach(e => {
                e[0] = new Date(e[0]).getTime()

            })
            console.log(data);
            Highcharts.stockChart('sales-chart', {
                rangeSelector: {
                    selected: 5
                },

                title: {
                    text: 'Ventas enero - mayo'
                },

                series: [{
                    name: 'Ventas',
                    data: data,
                    tooltip: {
                        valueDecimals: 2
                    }
                }]
            });
        }
    };
    xhttp.open("POST", "{% url 'get_sales' %}", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.setRequestHeader("X-CSRFToken", csrftoken);
    xhttp.send();

    var chart1; // globally available


</script>
{% endblock %}